Инцидент: Недоступен сайт MediaWiki.

Автор отчета: Лиляна Ратушняк.

Дата: 7 января 2025 года

Причины инцидента: 

- Конфигурационный файл LocalSettings.php оказался пустым.
- Отсутствие свободного пространства на диске.
- Некорректная конфигурация в файле.

Предпринятые шаги для восстановления работы сервиса и устранения проблемы:

При попытке открыть сайт MediaWiki выводится сообщение:
 
"$wgServer must be set in LocalSettings.php"

Принято решение подключится к серверу с помощью ssh-ключа:

ssh -i /home/igor/ich/ich.pem ec2-user@3.79.39.74

Подключение не удалось. Выводится сообщение:

 WARNING: UNPROTECTED PRIVATE KEY FILE!

Изменяем права доступа при помощи команды:

chmod 600 /home/igor/ich/ich.pem

После чего повторная попытка подключится к серверу проходит успешно.

Проверили статус процесса httpd, используя команду:

sudo systemctl status httpd

Затем дальше пытаемся отыскать причину ошибки.
Исходя из сообщения "$wgServer must be set in LocalSettings.php" известно, что проблема связана с файлом LocalSettings.php. Находим этот файл, при помощи команды:

sudo find / -type f -name "LocalSettings.php"

При открытии файла с помощью текстового редактора:

 vim /var/www/html/mediawiki/LocalSettings.php

обнаруживаем, что файл пуст.

Находясь в домашней директории командой ls -l проверяем имеющиеся файлы и обнаруживаем файл LocalSettings (5).php. При попытке открыть файл получаем сообщение: 

"No space left on device"

Используя команду df -h проверяем свободное дисковое пространство и оно оказывается практически полностью использованным.

Ищем файлы, которые занимают больше 1 гигабайта, с помощью команды:

sudo find / -type f -size +1G	
	
Обнаружен файл /var/log/httpd/access_log. Использовав команду 

sudo du -h /var/log/httpd/access_log, 

узнаем, что файл занимает 7 гигабайт.

Очищаем файл командой:

 sudo truncate -s 0 /var/log/httpd/access_log	

После совершенных действий открытие файла LocalSettings (5).php стало возможным. Файл является конфигурационным, но для корректной работы необходимо переместить и переименовать его, для чего мы используем команду:
 
cp LocalSettings (5).php /var/www/html/mediawiki/LocalSettings.php

При просмотре содержимого файла было обнаружено некорректное значение переменной:

$wgServer = "https://18.153.51.162"

Было внесено изменение: 

$wgServer = "https://3.79.39.74"

После внесенных изменений доступ к сайту был восстановлен.  

Для предотвращения возникновения подобной проблемы в будущем был разработан скрипт, который архивирует логи, очищает их и удаляет архивы старше 1 дня. 

При помощи команды

chmod +x log_backup.sh

делаем скрипт исполняемым.

Для того, чтобы скрипт исполнялся автоматически необходимо использовать crontab.

При введении команды

sudo crontab -l

обнаруживается, что у пользователя root уже есть задача

* * * * * tar -czf /var/log/httpd/log_$(date +\%Y\%m\%d).tar.gz -C /var/log/httpd .

которая архивирует архив и выполняет это каждую минуту, что и послужило причиной накопления архивов.

Закомментировав эту задачу, создаем новую на исполнение скрипта один раз в сутки:

0 0 * * * /home/ec2-user/log_backup.sh

Результаты: 

- Доступ к сайту был восстановлен
- Проблема с отсутствием свободного пространства на диске была решена

Рекомендации по улучшению процессов:

- Мониторинг дискового пространства
- Регулярная проверка задач crontab
